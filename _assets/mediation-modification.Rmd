---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Mediation and effect modification

Lets assume there is no direct effect. Our medication only impact the outcome through the mediator. For example a blood pressure drug and dementia. Effect modification can now arise at two points in our diagram. The effect of treatment on the mediator and the effect of the mediator on the outcome. It could be that a patients baseline bloop pressure modifies the extent of a treatment effect. There may be effect magnification 
as blood pressure rises. (As an aside such as effect can appear when a multiplicative effect is modeled on a linear scale).  

<diagram>

### An unconfounded mediation model

Imagine X0 means high or low baseline blood pressure. 

```{r}
mediation_scen3 <- function(N,alpha,beta,gamma) {
  #
  A <- rbinom(N,1,0.5)
  X0 <- rbinom(N,1,0.2)  
  M <- alpha*A + alpha1*A*X0 + rnorm(N)
  Y <- beta*A + gamma*M + gamma1*A*X0 + rnorm(N)
  
  alpha_ <- mean(M[A==1]) - mean(M[A==0])
  mod <- lm(Y ~ A*X0 + M)
  beta_ <- as.numeric(coef(mod)["A"])
  gamma_ <- as.numeric(coef(mod)["M"])
  tau_ <-  mean(Y[A==1]) - mean(Y[A==0])
  
  c()
}
```



```{r}
B <- 200
alpha <- 1.2
alpha1 <- 1.1
beta <- 0.0
gamma <- 1.1
gamma1 <- 1.05
N <- 1000
res <- matrix(ncol=3,nrow=B)
true_res <- c(beta + alpha*gamma,beta,alpha*gamma)
for (b in 1:B) {
  res[b,] <- mediation_scen2(N,alpha,alpha1,beta,gamma,gamma1) - true_res
}

res <- data.frame(res)
names(res) <- c("total","direct","indirect")
res <- tidyr::pivot_longer(res,cols=1:3,names_to="estimand",values_to="error")


ggplot(res) +
  geom_density(aes(x=error,col=estimand)) +
  labs(x = "Error\n(estimate - truth)") +
  theme_bw(base_size = 16)

```
